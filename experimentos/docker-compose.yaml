name: ldp

x-app-base: &app-base
  image: ldp:${IMAGE_TAG:-local}
  build:
    context: .
    args:
      GPU: ${GPU_BUILD:-0}
  working_dir: /app
  env_file:
    - .env
  environment:
    LDP_STORAGE_PROVIDER: ${LDP_STORAGE_PROVIDER:-local}
    LDP_STORAGE_BASE_PATH: /app
    LDP_N_JOBS: ${LDP_N_JOBS:-1}
    LDP_MODELS_N_JOBS: ${LDP_MODELS_N_JOBS:-1}
    LDP_SEQUENTIAL: ${LDP_SEQUENTIAL:-true}
    LDP_CV_FOLDS: ${LDP_CV_FOLDS:-3}
    LDP_NUM_SEEDS: ${LDP_NUM_SEEDS:-5}
    LDP_USE_GPU: ${LDP_USE_GPU:-false}
  volumes:
    - ./data:/app/data
    - ./models:/app/models
    - ./predictions:/app/predictions
    - ./reports:/app/reports
    - ./results:/app/results
  mem_limit: ${LDP_MEM_LIMIT:-24g}
  cpus: ${LDP_CPUS:-8.0}
  shm_size: ${LDP_SHM_SIZE:-2g}

services:
  app:
    <<: *app-base

  app-gpu:
    <<: *app-base
    profiles: ["gpu"]
    build:
      context: .
      args:
        GPU: 1
    environment:
      LDP_USE_GPU: true
    gpus: all